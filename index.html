<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Feeding Report Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-pen: #0f3460;
            --bg-card: #1e3a5f;
            --accent-primary: #e94560;
            --accent-secondary: #f39c12;
            --accent-success: #2ecc71;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #6c7a89;
            --status-all: #2ecc71;
            --status-three-quarter: #9acd32;
            --status-half: #f1c40f;
            --status-quarter: #e67e22;
            --status-none: #e74c3c;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 2px solid var(--accent-primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .header .status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .header .status.connected {
            color: var(--accent-success);
        }

        .header .status.error {
            color: var(--status-none);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        /* Dog Input Section */
        .input-section {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            min-width: 0;
        }

        .input-row input:focus {
            border-color: var(--accent-primary);
        }

        .input-row input::placeholder {
            color: var(--text-muted);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #d63d55;
        }

        .btn-success {
            background: var(--accent-success);
            color: white;
        }

        .btn-secondary {
            background: var(--text-muted);
            color: white;
        }

        /* Staging Area */
        .staging-section {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            min-height: 80px;
        }

        .staging-section h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .staging-area {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        .staging-area.drag-over {
            background: rgba(233, 69, 96, 0.1);
            border-radius: var(--radius-sm);
        }

        /* Dog Cards */
        .dog-card {
            background: var(--bg-pen);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: transform 0.15s, box-shadow 0.15s;
            border-left: 4px solid var(--text-muted);
        }

        .dog-card:active {
            cursor: grabbing;
        }

        .dog-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .dog-card .dog-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .dog-card.unmatched {
            border-left-color: var(--accent-secondary);
            padding: 10px 12px;
            cursor: default;
        }

        .dog-card.unmatched .warning-icon {
            color: var(--accent-secondary);
            margin-right: 5px;
        }

        .dog-card.unmatched .dog-name {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .match-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--accent-secondary);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .no-match-error {
            font-size: 0.75rem;
            color: var(--status-none);
            margin: 5px 0;
        }

        .delete-btn {
            background: var(--status-none);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 5px;
        }

        /* Pens Section */
        .pens-section {
            margin-bottom: 15px;
        }

        .pens-section h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 5px;
        }

        .pens-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        @media (max-width: 768px) {
            .pens-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 500px) {
            .pens-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .pen {
            background: var(--bg-pen);
            border-radius: var(--radius);
            padding: 10px;
            min-height: 150px;
            border: 2px dashed var(--text-muted);
            transition: all 0.2s;
        }

        .pen.drag-over {
            border-color: var(--accent-primary);
            background: rgba(233, 69, 96, 0.1);
        }

        .pen.full {
            border-color: var(--status-none);
        }

        .pen-header {
            text-align: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--text-muted);
        }

        .pen-dogs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Dog Card in Pen */
        .pen-dog-card {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 10px;
            border-left: 4px solid var(--status-all);
            cursor: grab;
            touch-action: none;
        }

        .pen-dog-card.dragging {
            opacity: 0.5;
        }

        .pen-dog-card .dog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .pen-dog-card .dog-name {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .pen-dog-card .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
        }

        .pen-dog-card .remove-btn:hover {
            color: var(--status-none);
        }

        /* Dog Controls */
        .dog-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .dog-controls select {
            padding: 5px 8px;
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.8rem;
            min-width: 60px;
        }

        .toggle-btn {
            padding: 5px 10px;
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }

        /* Expanded Supplements */
        .supplements-panel {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--text-muted);
        }

        .supplements-panel.active {
            display: block;
        }

        .supplement-checks {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .supplement-check {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .supplement-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-secondary);
        }

        /* Prescription Panel */
        .prescription-panel {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--text-muted);
        }

        .prescription-panel.active {
            display: block;
        }

        .prescription-panel input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--accent-primary);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
        }

        .prescription-panel input::placeholder {
            color: var(--text-muted);
        }

        /* Status Colors */
        .pen-dog-card[data-status="All"] { border-left-color: var(--status-all); }
        .pen-dog-card[data-status="3/4"] { border-left-color: var(--status-three-quarter); }
        .pen-dog-card[data-status="1/2"] { border-left-color: var(--status-half); }
        .pen-dog-card[data-status="1/4"] { border-left-color: var(--status-quarter); }
        .pen-dog-card[data-status="None"] { border-left-color: var(--status-none); }

        /* Bin (Delete Zone) */
        .bin-zone {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .bin-zone.drag-over {
            opacity: 1;
            transform: scale(1.02);
        }

        .bin-zone .bin-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .bin-zone .bin-text {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Bottom Controls */
        .bottom-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--accent-primary);
            padding: 15px 20px;
            z-index: 100;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 600px;
            margin: 0 auto;
        }

        .meal-select {
            padding: 10px 15px;
            border: 2px solid var(--accent-primary);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 2px solid var(--accent-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
            color: var(--accent-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .preview-pen {
            margin-bottom: 15px;
        }

        .preview-pen-header {
            font-weight: 700;
            color: var(--accent-secondary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .preview-dog {
            padding: 8px 12px;
            background: var(--bg-pen);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .preview-dog .extras {
            color: var(--accent-secondary);
            font-size: 0.8rem;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--bg-pen);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-pen);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 15px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        /* Empty State */
        .empty-message {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üçΩÔ∏è Feeding Report Manager</h1>
        <div class="status" id="connectionStatus">Connecting...</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Dog Input -->
        <div class="input-section">
            <div class="input-row">
                <input type="text" id="dogInput" placeholder="Type dog name (e.g. Luna G)..." autocomplete="off">
                <button class="btn btn-primary" onclick="addDog()">Add</button>
            </div>
        </div>

        <!-- Staging Area -->
        <div class="staging-section">
            <h3>üêï Dogs to Assign (<span id="stagingCount">0</span>)</h3>
            <div class="staging-area" id="stagingArea"></div>
        </div>

        <!-- Delete Bin -->
        <div class="bin-zone" id="binZone">
            <div class="bin-icon">üóëÔ∏è</div>
            <div class="bin-text">Drag here to remove</div>
        </div>

        <!-- Top Pens (1-5) -->
        <div class="pens-section">
            <h3>Top Pens (1-5)</h3>
            <div class="pens-grid" id="topPens"></div>
        </div>

        <!-- Bottom Pens (6-10) -->
        <div class="pens-section">
            <h3>Bottom Pens (6-10)</h3>
            <div class="pens-grid" id="bottomPens"></div>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-controls">
        <div class="controls-row">
            <select class="meal-select" id="mealType">
                <option value="Morning Meal">üåÖ Morning</option>
                <option value="Lunch Meal">‚òÄÔ∏è Lunch</option>
                <option value="Evening Meal">üåô Evening</option>
            </select>
            <button class="btn btn-secondary" onclick="clearAll()">Clear</button>
            <button class="btn btn-primary" onclick="showPreview()">Preview</button>
            <button class="btn btn-success" onclick="submitReport()">Submit</button>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üìã Report Preview</h2>
                <button class="modal-close" onclick="closePreview()">√ó</button>
            </div>
            <div class="modal-body" id="previewContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePreview()">Back</button>
                <button class="btn btn-success" onclick="submitReport()">Submit to Telegram</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // !!! IMPORTANT: Replace this with your deployed Apps Script URL !!!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwP74AXOe1cZmHKTxi9KbMhZJU48EHRFI7NQ6Og65_FcTVB1sMQuqgkPKIkr7Fm7e40mw/exec';
        
        // Fallback dog list (used if API fails) - from JotForm field 13
        const FALLBACK_DOG_NAMES = [
            "Aldo","Alfie","April","Argo","Arlo","Banjo","Barney Homewood","Barney Leeming","Baron","Bay","Beano","Bella","Belle","Benson","Betsy","Birdy","Blue","Bluey","Bo","Bonnie Gallagher","Bonnie Lockwood","Bramble","Branko","Bruce","Bruno","Buddy Dann","Buddy Dargan","Buddy Selby","Casper Hamilton","Casper Kukreja","Che","Chester","Chloe","Clifford","Daisy Cremin","Daisy Parsons","Darcy Campbell","Darcy Dunn","Darwin","Delphine","Dexter","Dicee","Diego Gonsavles","Diego Wojcik","Dierdra","Digby","Dolly","Dottie","Dougie","Dudley","Dusty","Echo","Eddie","Effie","Enzo","Fenton","Ferox","Flaco","Fletcher","Florence","Freddie","Fredo","Frida Walsh","George Elliston","George Jackson","George Mohammed","Gina","Goldie","Haggis","Hattie Campbell","Hattie Duncan","Henry","Holly","Hugo","Incy","Ivy","Jack","Jeff","Jessie","Keti","Kip","Koji","Leo","Lily","Lola Bowles","Lola Fenloni","Lola Hall","Luke","Luna Crockford","Luna Grimshaw","Mac","Macy","Maggie","Margo","Marli","Marloe","Marlow","Martha","Max Tigwell","Max Wang","Merlin Crowley","Merlin Mayne","Miles","Miley","Millie Bowles","Millie Carter","Millie Cartwright","Millie Ellis","Milo McVey","Missy Evans","Mocha Gasper","Mocha Kolumbajew","Mochi","Moka","Mollie","Mos Wan","Moss Harris","Naira","Nala Sands","Nala Warnes","Narla Tester","Ned","Neo","Nevis","Nina","Obie","Oliver","Otis","Peggy Gibbons","Peggy Lucas","Pepper","Petch","Pippin","Pluto","Poppy Clark","Poppy Lancaster","Poppy Lass","Poppy Pike","Ralph Goddard","Raven","Reggie Daly","Reggie Foreman","Reggie Russel","Rex","Rita","River","Rocco","Roman","Roxy","Ruby Brooker","Ruby Favell","Ruby Jones","Rudy","Ruffles","Rufus","Rupy","Sam","Sebastian","Shadow Podkalicka","Shadow Wightman","Snoopy","Sonny","Sophie","Stanley James","Star","Storm","Tallulah","Tam","Tasha","Ted Lambie","Teddy Brown","Teddy Jamison","Terry","Tilly Mills","Tokyo","Warwick","Winnie Awele","Winnie Evans","Winnie Hall","Winnie Lancaster","Winnie Ryan","Woody Johns","Woody Warren","Zero","Ziggy"
        ];
        
        const SUPPLEMENT_TYPES = [
            { id: 'calming', label: 'Calming', jotformValue: 'Calming Tablets' },
            { id: 'hemp', label: 'Hemp', jotformValue: 'Hemp Oil' },
            { id: 'vitamins', label: 'Vitamins', jotformValue: 'Multi Vitamins' },
            { id: 'probiotics', label: 'Probiotics', jotformValue: 'FortiFlora Probiotics' }
        ];

        // Feeding status mapping to JotForm values
        const FEEDING_STATUS_MAP = {
            'all': 'All',
            'three-quarter': '3/4',
            'half': '1/2',
            'quarter': '1/4',
            'none': 'None'
        };

        const FEEDING_OPTIONS = [
            { value: 'all', label: 'All' },
            { value: 'three-quarter', label: '¬æ' },
            { value: 'half', label: '¬Ω' },
            { value: 'quarter', label: '¬º' },
            { value: 'none', label: 'None' }
        ];
        
        const MAX_DOGS_PER_PEN = 5;

        // ============================================
        // STATE
        // ============================================
        
        let masterDogList = []; // From Google Sheet Lookup tab
        let dogNameList = []; // Just the names for matching
        let dogs = []; // Current session dogs
        let pens = {}; // pen-1 to pen-10 -> array of dog IDs
        let draggedDogId = null;
        let draggedFromPen = null;
        let draggedElement = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            initPens();
            setupEventListeners();
            await loadDogList();
        });

        function initPens() {
            const topPensEl = document.getElementById('topPens');
            const bottomPensEl = document.getElementById('bottomPens');
            
            // Create pens 1-5 (top)
            for (let i = 1; i <= 5; i++) {
                const penId = `pen-${i}`;
                pens[penId] = [];
                topPensEl.innerHTML += createPenHTML(penId, i);
            }
            
            // Create pens 6-10 (bottom)
            for (let i = 6; i <= 10; i++) {
                const penId = `pen-${i}`;
                pens[penId] = [];
                bottomPensEl.innerHTML += createPenHTML(penId, i);
            }
        }

        function createPenHTML(penId, penNum) {
            return `
                <div class="pen" id="${penId}" data-pen="${penId}">
                    <div class="pen-header">Pen ${penNum}</div>
                    <div class="pen-dogs" id="${penId}-dogs"></div>
                </div>
            `;
        }

        function setupEventListeners() {
            // Input field events
            const input = document.getElementById('dogInput');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addDog();
            });

            // Setup drag zones
            setupDragZones();
        }

        // ============================================
        // API CALLS
        // ============================================
        
        async function loadDogList() {
            showLoading('Loading dog list...');
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getDogList' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    masterDogList = result.dogs;
                    dogNameList = result.dogs.map(d => d.name);
                    updateStatus(`‚úì Connected (${result.count} dogs)`, 'connected');
                } else {
                    throw new Error(result.error || 'Failed to load dogs');
                }
            } catch (error) {
                console.error('Load error:', error);
                // Use fallback list
                dogNameList = FALLBACK_DOG_NAMES;
                masterDogList = FALLBACK_DOG_NAMES.map(name => ({ name, email: '', parentName: '' }));
                
                if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    updateStatus('‚ö† Demo mode - set APPS_SCRIPT_URL', 'error');
                } else {
                    updateStatus(`‚ö† Offline mode (${dogNameList.length} dogs)`, 'error');
                }
            }
            
            hideLoading();
        }

        async function submitToBackend(reportData) {
            showLoading('Submitting report...');
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'submitReport',
                        ...reportData
                    })
                });
                
                const result = await response.json();
                hideLoading();
                
                return result;
            } catch (error) {
                hideLoading();
                return { success: false, error: error.toString() };
            }
        }

        // ============================================
        // NAME MATCHING FUNCTIONS
        // ============================================
        
        /**
         * Match dog name to master list
         * Supports: "Luna" (first name only) or "Luna G" (first name + surname initial)
         */
        function matchDogName(inputName) {
            const parts = inputName.trim().split(/\s+/);
            const firstName = parts[0];
            const surnameInitial = parts.length > 1 ? parts.slice(1).join(' ').toUpperCase() : null;

            // Find all matches
            const matches = dogNameList.filter(fullName => {
                const nameParts = fullName.split(' ');
                const jotFirstName = nameParts[0];
                const jotSurname = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';

                // First name must match exactly (case insensitive)
                if (jotFirstName.toLowerCase() !== firstName.toLowerCase()) {
                    return false;
                }

                // If no surname initial provided, match all with that first name
                if (!surnameInitial) {
                    return true;
                }

                // Surname must start with the provided initial(s)
                return jotSurname.toUpperCase().startsWith(surnameInitial);
            });

            return matches;
        }

        /**
         * Fuzzy match dog name - finds similar names when exact match fails
         * Uses scoring algorithm to rank matches
         */
        function fuzzyMatchDogName(inputName) {
            const input = inputName.trim().toLowerCase();
            const inputParts = input.split(/\s+/);
            const firstName = inputParts[0];
            
            // Score each dog name based on similarity
            const scored = dogNameList.map(fullName => {
                const nameParts = fullName.toLowerCase().split(' ');
                const jotFirstName = nameParts[0];
                
                let score = 0;
                
                // Exact first name match = highest score
                if (jotFirstName === firstName) {
                    score += 100;
                }
                // First name starts with input = high score
                else if (jotFirstName.startsWith(firstName)) {
                    score += 80;
                }
                // Input starts with first name = good score
                else if (firstName.startsWith(jotFirstName)) {
                    score += 60;
                }
                // First few letters match = medium score
                else if (jotFirstName.substring(0, 2) === firstName.substring(0, 2)) {
                    score += 40;
                }
                // First letter matches = low score
                else if (jotFirstName[0] === firstName[0]) {
                    score += 20;
                }
                
                // Bonus for surname initial match if provided
                if (inputParts.length > 1 && nameParts.length > 1) {
                    const inputSurname = inputParts.slice(1).join(' ').toUpperCase();
                    const jotSurname = nameParts.slice(1).join(' ').toUpperCase();
                    if (jotSurname.startsWith(inputSurname)) {
                        score += 50;
                    } else if (jotSurname[0] === inputSurname[0]) {
                        score += 25;
                    }
                }
                
                return { name: fullName, score };
            });
            
            // Return top matches with score > 0, sorted by score
            return scored
                .filter(s => s.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 15) // Limit to top 15 matches
                .map(s => s.name);
        }

        // ============================================
        // DOG INPUT & MANAGEMENT
        // ============================================
        
        function addDog() {
            const input = document.getElementById('dogInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            // Check if already added
            if (dogs.some(d => d.inputName.toLowerCase() === name.toLowerCase())) {
                alert(`${name} is already added!`);
                return;
            }
            
            // Try to match to master list
            const matches = matchDogName(name);
            
            const dog = {
                id: 'dog-' + Date.now() + Math.random(),
                inputName: name,
                matchedName: matches.length === 1 ? matches[0] : null,
                possibleMatches: matches,
                status: 'all',
                supplements: false,
                supplementTypes: [],
                prescription: false,
                prescriptionMedicine: ''
            };
            
            dogs.push(dog);
            input.value = '';
            input.focus();
            renderStagingArea();
        }

        function selectStagingMatch(dogId, matchedName) {
            const dog = dogs.find(d => d.id === dogId);
            if (dog && matchedName) {
                dog.matchedName = matchedName;
                renderStagingArea();
            }
        }

        function deleteDog(dogId) {
            // Remove from pens
            for (const penId of Object.keys(pens)) {
                pens[penId] = pens[penId].filter(id => id !== dogId);
            }
            // Remove from dogs array
            dogs = dogs.filter(d => d.id !== dogId);
            renderStagingArea();
            for (let i = 1; i <= 10; i++) {
                renderPen(`pen-${i}`);
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        
        function renderStagingArea() {
            const stagingArea = document.getElementById('stagingArea');
            const stagingDogs = dogs.filter(d => !getDogPen(d.id));
            
            document.getElementById('stagingCount').textContent = stagingDogs.length;
            
            if (stagingDogs.length === 0) {
                stagingArea.innerHTML = '<div class="empty-message">Add dogs above, then drag them to pens</div>';
                return;
            }
            
            stagingArea.innerHTML = stagingDogs.map(dog => {
                const isMatched = dog.matchedName || dog.possibleMatches.length === 1;
                
                if (isMatched) {
                    // Matched dog - show as draggable card
                    const finalName = dog.matchedName || dog.possibleMatches[0];
                    return `
                        <div class="dog-card" id="${dog.id}" data-dog-id="${dog.id}">
                            <span class="dog-name">${escapeHtml(finalName)}</span>
                        </div>
                    `;
                } else {
                    // Unmatched dog - show dropdown with fuzzy matches
                    const fuzzyMatches = dog.possibleMatches.length > 0 
                        ? dog.possibleMatches 
                        : fuzzyMatchDogName(dog.inputName);
                    
                    if (fuzzyMatches.length === 0) {
                        // No matches at all - show error state
                        return `
                            <div class="dog-card unmatched" id="${dog.id}" data-dog-id="${dog.id}">
                                <div class="dog-name">
                                    <span class="warning-icon">‚ö†Ô∏è</span>
                                    "${escapeHtml(dog.inputName)}"
                                </div>
                                <div class="no-match-error">No matching dogs found</div>
                                <button class="delete-btn" onclick="deleteDog('${dog.id}')">Remove</button>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="dog-card unmatched" id="${dog.id}" data-dog-id="${dog.id}">
                            <div class="dog-name">
                                <span class="warning-icon">‚ö†Ô∏è</span>
                                "${escapeHtml(dog.inputName)}"
                            </div>
                            <select class="match-select" onchange="selectStagingMatch('${dog.id}', this.value)">
                                <option value="">Select correct dog...</option>
                                ${fuzzyMatches.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
            }).join('');
            
            // Setup drag for matched staging cards only
            stagingDogs.forEach(dog => {
                const isMatched = dog.matchedName || dog.possibleMatches.length === 1;
                if (isMatched) {
                    const el = document.getElementById(dog.id);
                    if (el) setupDragForElement(el, null);
                }
            });
        }

        function renderPen(penId) {
            const penDogsEl = document.getElementById(`${penId}-dogs`);
            const penDogIds = pens[penId] || [];
            
            const penEl = document.getElementById(penId);
            penEl.classList.toggle('full', penDogIds.length >= MAX_DOGS_PER_PEN);
            
            if (penDogIds.length === 0) {
                penDogsEl.innerHTML = '';
                return;
            }
            
            penDogsEl.innerHTML = penDogIds.map(dogId => {
                const dog = dogs.find(d => d.id === dogId);
                if (!dog) return '';
                
                const displayName = dog.matchedName || dog.possibleMatches[0] || dog.inputName;
                const statusColor = getStatusColor(dog.status);
                
                return `
                    <div class="pen-dog-card" id="${dog.id}" data-dog-id="${dog.id}" data-status="${dog.status}" style="border-left-color: ${statusColor}">
                        <div class="dog-header">
                            <span class="dog-name">${escapeHtml(displayName)}</span>
                            <button class="remove-btn" onclick="removeDogFromPen('${dog.id}', '${penId}')">√ó</button>
                        </div>
                        <div class="dog-controls">
                            <select onchange="updateDogStatus('${dog.id}', this.value)">
                                ${FEEDING_OPTIONS.map(opt => 
                                    `<option value="${opt.value}" ${dog.status === opt.value ? 'selected' : ''}>${opt.label}</option>`
                                ).join('')}
                            </select>
                            <button class="toggle-btn ${dog.supplements ? 'active' : ''}" onclick="toggleSupplements('${dog.id}')">+S</button>
                            <button class="toggle-btn ${dog.prescription ? 'active' : ''}" onclick="togglePrescription('${dog.id}')">+P</button>
                        </div>
                        <div class="supplements-panel ${dog.supplements ? 'active' : ''}" id="supp-${dog.id}">
                            <div class="supplement-checks">
                                ${SUPPLEMENT_TYPES.map(supp => `
                                    <label class="supplement-check">
                                        <input type="checkbox" 
                                            ${dog.supplementTypes.includes(supp.id) ? 'checked' : ''} 
                                            onchange="toggleSupplementType('${dog.id}', '${supp.id}')">
                                        ${supp.label}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="prescription-panel ${dog.prescription ? 'active' : ''}" id="presc-${dog.id}">
                            <input type="text" 
                                placeholder="Medicine name..." 
                                value="${escapeHtml(dog.prescriptionMedicine)}"
                                onchange="updatePrescriptionMedicine('${dog.id}', this.value)">
                        </div>
                    </div>
                `;
            }).join('');
            
            // Setup drag for pen cards
            penDogIds.forEach(dogId => {
                const el = document.getElementById(dogId);
                if (el) setupDragForElement(el, penId);
            });
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'all': 'var(--status-all)',
                'three-quarter': 'var(--status-three-quarter)',
                'half': 'var(--status-half)',
                'quarter': 'var(--status-quarter)',
                'none': 'var(--status-none)'
            };
            return colors[status] || 'var(--status-all)';
        }

        // Get status label for preview
        function getStatusLabel(status) {
            const labels = {
                'all': 'All',
                'three-quarter': '¬æ',
                'half': '¬Ω',
                'quarter': '¬º',
                'none': 'None'
            };
            return labels[status] || status;
        }

        function getDogPen(dogId) {
            for (const [penId, dogIds] of Object.entries(pens)) {
                if (dogIds.includes(dogId)) return penId;
            }
            return null;
        }

        function updateDogStatus(dogId, status) {
            const dog = dogs.find(d => d.id === dogId);
            if (dog) {
                dog.status = status;
                const penId = getDogPen(dogId);
                if (penId) renderPen(penId);
            }
        }

        function toggleSupplements(dogId) {
            const dog = dogs.find(d => d.id === dogId);
            if (!dog) return;
            
            dog.supplements = !dog.supplements;
            if (!dog.supplements) {
                dog.supplementTypes = [];
            }
            
            const penId = getDogPen(dogId);
            if (penId) renderPen(penId);
        }

        function toggleSupplementType(dogId, suppId) {
            const dog = dogs.find(d => d.id === dogId);
            if (!dog) return;
            
            if (dog.supplementTypes.includes(suppId)) {
                dog.supplementTypes = dog.supplementTypes.filter(s => s !== suppId);
            } else {
                dog.supplementTypes.push(suppId);
            }
        }

        function togglePrescription(dogId) {
            const dog = dogs.find(d => d.id === dogId);
            if (!dog) return;
            
            dog.prescription = !dog.prescription;
            if (!dog.prescription) {
                dog.prescriptionMedicine = '';
            }
            
            const penId = getDogPen(dogId);
            if (penId) renderPen(penId);
        }

        function updatePrescriptionMedicine(dogId, value) {
            const dog = dogs.find(d => d.id === dogId);
            if (dog) dog.prescriptionMedicine = value;
        }

        function removeDogFromPen(dogId, penId) {
            pens[penId] = pens[penId].filter(id => id !== dogId);
            renderPen(penId);
            renderStagingArea();
        }

        // ============================================
        // DRAG AND DROP (Pointer Events)
        // ============================================
        
        function setupDragZones() {
            // Staging area as drop zone
            const stagingArea = document.getElementById('stagingArea');
            setupDropZone(stagingArea, null);
            
            // Bin zone
            const binZone = document.getElementById('binZone');
            setupDropZone(binZone, 'bin');
            
            // Pens as drop zones
            for (let i = 1; i <= 10; i++) {
                const pen = document.getElementById(`pen-${i}`);
                setupDropZone(pen, `pen-${i}`);
            }
        }

        function setupDragForElement(el, fromPen) {
            let startX, startY, clone;
            
            const onPointerDown = (e) => {
                if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'BUTTON' || e.target.closest('.match-dropdown')) {
                    return;
                }
                
                e.preventDefault();
                draggedDogId = el.dataset.dogId;
                draggedFromPen = fromPen;
                
                startX = e.clientX;
                startY = e.clientY;
                
                clone = el.cloneNode(true);
                clone.style.position = 'fixed';
                clone.style.width = el.offsetWidth + 'px';
                clone.style.zIndex = '1000';
                clone.style.pointerEvents = 'none';
                clone.style.opacity = '0.9';
                clone.style.left = e.clientX - el.offsetWidth / 2 + 'px';
                clone.style.top = e.clientY - 20 + 'px';
                document.body.appendChild(clone);
                
                el.classList.add('dragging');
                
                document.addEventListener('pointermove', onPointerMove);
                document.addEventListener('pointerup', onPointerUp);
            };
            
            const onPointerMove = (e) => {
                if (!clone) return;
                clone.style.left = e.clientX - clone.offsetWidth / 2 + 'px';
                clone.style.top = e.clientY - 20 + 'px';
                
                // Highlight drop zones
                document.querySelectorAll('.pen, .staging-area, .bin-zone').forEach(zone => {
                    const rect = zone.getBoundingClientRect();
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        zone.classList.add('drag-over');
                    } else {
                        zone.classList.remove('drag-over');
                    }
                });
            };
            
            const onPointerUp = (e) => {
                document.removeEventListener('pointermove', onPointerMove);
                document.removeEventListener('pointerup', onPointerUp);
                
                if (clone) {
                    clone.remove();
                    clone = null;
                }
                
                el.classList.remove('dragging');
                
                // Find drop target
                const dropTarget = document.elementFromPoint(e.clientX, e.clientY);
                handleDrop(dropTarget);
                
                document.querySelectorAll('.drag-over').forEach(z => z.classList.remove('drag-over'));
                
                draggedDogId = null;
                draggedFromPen = null;
            };
            
            el.addEventListener('pointerdown', onPointerDown);
        }

        function setupDropZone(el, targetId) {
            // Drop zones are handled via elementFromPoint in pointer up
        }

        function handleDrop(dropTarget) {
            if (!draggedDogId || !dropTarget) return;
            
            // Find the actual drop zone
            const pen = dropTarget.closest('.pen');
            const staging = dropTarget.closest('.staging-area');
            const bin = dropTarget.closest('.bin-zone');
            
            // Remove from current location
            if (draggedFromPen) {
                pens[draggedFromPen] = pens[draggedFromPen].filter(id => id !== draggedDogId);
            }
            
            if (bin) {
                // Delete dog
                dogs = dogs.filter(d => d.id !== draggedDogId);
            } else if (pen) {
                const penId = pen.dataset.pen;
                
                // Check pen capacity
                if (pens[penId].length >= MAX_DOGS_PER_PEN) {
                    alert(`Pen ${penId.replace('pen-', '')} is full (max ${MAX_DOGS_PER_PEN} dogs)`);
                    // Return to original location
                    if (draggedFromPen) {
                        pens[draggedFromPen].push(draggedDogId);
                    }
                } else if (!pens[penId].includes(draggedDogId)) {
                    pens[penId].push(draggedDogId);
                }
            }
            // If dropped on staging or elsewhere, dog stays in staging (handled by filter)
            
            // Re-render
            renderStagingArea();
            for (let i = 1; i <= 10; i++) {
                renderPen(`pen-${i}`);
            }
        }

        // ============================================
        // PREVIEW & SUBMIT
        // ============================================
        
        function showPreview() {
            const previewContent = document.getElementById('previewContent');
            const mealType = document.getElementById('mealType').value;
            
            let html = `<p><strong>Meal:</strong> ${mealType}</p><hr style="border-color: var(--bg-pen); margin: 15px 0;">`;
            let totalDogs = 0;
            
            for (let i = 1; i <= 10; i++) {
                const penId = `pen-${i}`;
                const penDogs = pens[penId];
                
                if (penDogs.length === 0) continue;
                
                html += `<div class="preview-pen">`;
                html += `<div class="preview-pen-header">üìç Pen ${i}</div>`;
                
                penDogs.forEach(dogId => {
                    const dog = dogs.find(d => d.id === dogId);
                    if (!dog) return;
                    
                    totalDogs++;
                    const name = dog.matchedName || dog.possibleMatches[0] || dog.inputName;
                    let extras = [];
                    if (dog.supplements) extras.push('+S');
                    if (dog.prescription) extras.push('+P');
                    
                    html += `<div class="preview-dog">
                        ${escapeHtml(name)} ‚Äî ${getStatusLabel(dog.status)}
                        ${extras.length ? `<span class="extras">${extras.join(' ')}</span>` : ''}
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            if (totalDogs === 0) {
                html = '<div class="empty-message">No dogs assigned to pens yet!</div>';
            } else {
                html = `<p><strong>Total:</strong> ${totalDogs} dogs</p>` + html;
            }
            
            previewContent.innerHTML = html;
            document.getElementById('previewModal').classList.add('active');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        async function submitReport() {
            closePreview();
            
            // Validate all dogs are matched
            const unmatchedDogs = [];
            const dogsToSubmit = [];
            
            for (let i = 1; i <= 10; i++) {
                const penId = `pen-${i}`;
                const penDogs = pens[penId];
                
                for (const dogId of penDogs) {
                    const dog = dogs.find(d => d.id === dogId);
                    if (!dog) continue;
                    
                    const finalName = dog.matchedName || dog.possibleMatches[0] || dog.inputName;
                    
                    // Check if name exists in master list (skip check if using fallback list)
                    const inMasterList = dogNameList.some(name => 
                        name.toLowerCase() === finalName.toLowerCase()
                    );
                    
                    if (!inMasterList && dogNameList.length > 0) {
                        unmatchedDogs.push(finalName);
                        continue;
                    }
                    
                    // Build medicine/supplements array
                    const medicineSupplements = [];
                    if (dog.prescription) {
                        medicineSupplements.push('Prescription Medicine');
                    }
                    dog.supplementTypes.forEach(suppId => {
                        const supp = SUPPLEMENT_TYPES.find(s => s.id === suppId);
                        if (supp) medicineSupplements.push(supp.jotformValue);
                    });
                    
                    dogsToSubmit.push({
                        name: finalName,
                        pen: penId,
                        foodConsumed: FEEDING_STATUS_MAP[dog.status] || dog.status,
                        hasMedicineOrSupplement: (dog.prescription || dog.supplements) ? 'Yes' : 'No',
                        medicineSupplements: medicineSupplements,
                        supplementTypes: dog.supplementTypes.map(id => {
                            const s = SUPPLEMENT_TYPES.find(x => x.id === id);
                            return s ? s.jotformValue : id;
                        }),
                        prescriptionMedicine: dog.prescriptionMedicine
                    });
                }
            }
            
            if (unmatchedDogs.length > 0) {
                alert(`‚ö†Ô∏è These dogs are not in the master list:\n\n${unmatchedDogs.join('\n')}\n\nPlease match them first.`);
                return;
            }
            
            if (dogsToSubmit.length === 0) {
                alert('No dogs to submit! Please assign dogs to pens first.');
                return;
            }
            
            // Get today's date
            const today = new Date();
            const reportDate = {
                day: today.getDate().toString(),
                month: (today.getMonth() + 1).toString(),
                year: today.getFullYear().toString()
            };
            
            const mealType = document.getElementById('mealType').value;
            
            // Submit to backend
            const result = await submitToBackend({
                mealType: mealType,
                date: reportDate,
                dogs: dogsToSubmit
            });
            
            if (result.success) {
                alert(`‚úÖ Success!\n\n${result.dogsProcessed} dogs submitted.\n\nCheck Telegram for review links.\n\nReply /send to submit to JotForm.`);
                
                // Clear the form
                clearAll();
            } else {
                alert(`‚ùå Error: ${result.error}\n\nPlease try again.`);
            }
        }

        function clearAll() {
            dogs = [];
            for (let i = 1; i <= 10; i++) {
                pens[`pen-${i}`] = [];
                renderPen(`pen-${i}`);
            }
            renderStagingArea();
        }

        // ============================================
        // UTILITIES
        // ============================================
        
        function updateStatus(message, type) {
            const el = document.getElementById('connectionStatus');
            el.textContent = message;
            el.className = 'status ' + (type || '');
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'Loading...';
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
    </script>
</body>
</html>
